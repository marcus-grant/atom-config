(function() {
  "use strict";
  var TwoDimArray, WrappedDomTree, curHash, hashTo,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  TwoDimArray = require('./two-dim-array');

  curHash = 0;

  hashTo = {};

  module.exports = WrappedDomTree = (function() {
    function WrappedDomTree(dom, clone, rep) {
      if (clone) {
        this.shownTree = new WrappedDomTree(dom, false, this);
        this.dom = dom.cloneNode(true);
      } else {
        this.dom = dom;
        this.rep = rep;
      }
      this.clone = clone;
      this.hash = curHash++;
      hashTo[this.hash] = this;
      this.isText = dom.nodeType === 3;
      this.tagName = dom.tagName;
      this.className = dom.className;
      this.textData = dom.data;
      this.diffHash = {};
      if (this.isText) {
        this.size = 1;
      } else {
        rep = this.rep;
        this.children = [].map.call(this.dom.childNodes, function(dom, ind) {
          return new WrappedDomTree(dom, false, rep ? rep.children[ind] : null);
        });
        this.size = this.children.length ? this.children.reduce((function(prev, cur) {
          return prev + cur.size;
        }), 0) : 0;
        if (!this.size) {
          this.size = 1;
        }
      }
    }

    WrappedDomTree.prototype.diffTo = function(otherTree) {
      var diff, fn, indexShift, inserted, k, last, lastElmDeleted, lastElmInserted, lastOp, len, op, operations, possibleReplace, r, ref, score;
      if (this.clone) {
        return this.shownTree.diffTo(otherTree);
      }
      diff = this.rep.diff(otherTree);
      score = diff.score;
      operations = diff.operations;
      indexShift = 0;
      inserted = [];
      ref = [], last = ref[0], possibleReplace = ref[1], r = ref[2], lastOp = ref[3], lastElmDeleted = ref[4], lastElmInserted = ref[5];
      if (operations) {
        if (operations instanceof Array) {
          fn = (function(_this) {
            return function(op) {
              var possibleLastDeleted, re;
              if (op.type === "d") {
                possibleLastDeleted = _this.children[op.tree + indexShift].dom;
                r = _this.remove(op.tree + indexShift);
                _this.rep.remove(op.tree + indexShift);
                if (!last || last.nextSibling === r || last === r) {
                  last = r;
                  if (last && lastOp && op.tree === lastOp.pos) {
                    lastElmDeleted = possibleLastDeleted;
                  } else {
                    lastElmDeleted = null;
                    lastElmInserted = null;
                  }
                  lastOp = op;
                }
                indexShift--;
              } else if (op.type === "i") {
                _this.rep.insert(op.pos + indexShift, otherTree.children[op.otherTree]);
                r = _this.insert(op.pos + indexShift, otherTree.children[op.otherTree], _this.rep.children[op.pos + indexShift]);
                inserted.push(r);
                if (!last || last.nextSibling === r) {
                  last = r;
                  lastOp = op;
                  lastElmInserted = r;
                }
                indexShift++;
              } else {
                re = _this.children[op.tree + indexShift].diffTo(otherTree.children[op.otherTree]);
                if (!last || (last.nextSibling === _this.children[op.tree + indexShift].dom && re.last)) {
                  last = re.last;
                  if (re.possibleReplace) {
                    lastElmInserted = re.possibleReplace.cur;
                    lastElmDeleted = re.possibleReplace.prev;
                  }
                  lastOp = op;
                }
                inserted = inserted.concat(re.inserted);
              }
            };
          })(this);
          for (k = 0, len = operations.length; k < len; k++) {
            op = operations[k];
            fn(op);
          }
        } else {
          console.log(operations);
          throw new Error("invalid operations");
        }
      }
      if (lastOp && lastOp.type !== 'i' && lastElmInserted && lastElmDeleted) {
        possibleReplace = {
          cur: lastElmInserted,
          prev: lastElmDeleted
        };
      }
      return {
        last: last,
        inserted: inserted,
        possibleReplace: possibleReplace
      };
    };

    WrappedDomTree.prototype.insert = function(i, tree, rep) {
      var ctree, dom;
      dom = tree.dom.cloneNode(true);
      if (i === this.dom.childNodes.length) {
        this.dom.appendChild(dom);
      } else {
        this.dom.insertBefore(dom, this.dom.childNodes[i]);
      }
      ctree = new WrappedDomTree(dom, false, rep);
      this.children.splice(i, 0, ctree);
      return this.dom.childNodes[i];
    };

    WrappedDomTree.prototype.remove = function(i) {
      this.dom.removeChild(this.dom.childNodes[i]);
      this.children[i].removeSelf();
      this.children.splice(i, 1);
      return this.dom.childNodes[i - 1];
    };

    WrappedDomTree.prototype.diff = function(otherTree, tmax) {
      var cc, cr, cur, dp, forwardSearch, getScore, i, k, key, l, offset, op, operations, p, pc, pr, prev, rc, ref, ref1, score, sum;
      if (this.equalTo(otherTree)) {
        return {
          score: 0,
          operations: null
        };
      }
      if (this.cannotReplaceWith(otherTree)) {
        return {
          score: 1 / 0,
          operations: null
        };
      }
      key = otherTree.hash;
      if (indexOf.call(this.diffHash, key) >= 0) {
        return this.diffHash[key];
      }
      if (tmax === void 0) {
        tmax = 100000;
      }
      if (tmax <= 0) {
        return 0;
      }
      offset = 0;
      forwardSearch = (function(_this) {
        return function(offset) {
          return offset < _this.children.length && offset < otherTree.children.length && _this.children[offset].equalTo(otherTree.children[offset]);
        };
      })(this);
      while (forwardSearch(offset)) {
        offset++;
      }
      dp = new TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
      p = new TwoDimArray(this.children.length + 1 - offset, otherTree.children.length + 1 - offset);
      dp.set(0, 0, 0);
      sum = 0;
      if (otherTree.children.length - offset > 1) {
        for (i = k = 1, ref = otherTree.children.length - offset - 1; 1 <= ref ? k <= ref : k >= ref; i = 1 <= ref ? ++k : --k) {
          dp.set(0, i, sum);
          p.set(0, i, i - 1);
          sum += otherTree.children[i + offset].size;
        }
      }
      if (otherTree.children.length - offset > 0) {
        dp.set(0, otherTree.children.length - offset, sum);
        p.set(0, otherTree.children.length - offset, otherTree.children.length - 1 - offset);
      }
      sum = 0;
      if (this.children.length - offset > 1) {
        for (i = l = 1, ref1 = this.children.length - offset - 1; 1 <= ref1 ? l <= ref1 : l >= ref1; i = 1 <= ref1 ? ++l : --l) {
          dp.set(i, 0, sum);
          p.set(i, 0, (i - 1) * p.col);
          sum += this.children[i + offset].size;
        }
      }
      if (this.children.length - offset) {
        dp.set(this.children.length - offset, 0, sum);
        p.set(this.children.length - offset, 0, (this.children.length - 1 - offset) * p.col);
      }
      getScore = (function(_this) {
        return function(i, j, max) {
          var bound, force, other, prev, subdiff, val;
          if (dp.get(i, j) !== void 0) {
            return dp.get(i, j);
          }
          if (max === void 0) {
            max = 1 / 0;
          }
          if (max <= 0) {
            return 1 / 0;
          }
          val = max;
          bound = max;
          subdiff = _this.children[i - 1 + offset].diff(otherTree.children[j - 1 + offset], bound).score;
          force = false;
          if (subdiff < bound && subdiff + 1 < _this.children[i - 1 + offset].size + otherTree.children[j - 1 + offset].size) {
            force = true;
          }
          val = getScore(i - 1, j - 1, bound - subdiff) + subdiff;
          prev = p.getInd(i - 1, j - 1);
          if (!force) {
            other = getScore(i - 1, j, Math.min(val, max) - _this.children[i - 1 + offset].size) + _this.children[i - 1 + offset].size;
            if (other < val) {
              prev = p.getInd(i - 1, j);
              val = other;
            }
            other = getScore(i, j - 1, Math.min(val, max) - otherTree.children[j - 1 + offset].size) + otherTree.children[j - 1 + offset].size;
            if (other < val) {
              prev = p.getInd(i, j - 1);
              val = other;
            }
          }
          if (val >= max) {
            val = 1 / 0;
          }
          dp.set(i, j, val);
          p.set(i, j, prev);
          return val;
        };
      })(this);
      score = getScore(this.children.length - offset, otherTree.children.length - offset, tmax);
      operations = [];
      cur = p.getInd(this.children.length - offset, otherTree.children.length - offset);
      cr = this.children.length - 1 - offset;
      cc = otherTree.children.length - 1 - offset;
      while (p.rawGet(cur) !== void 0) {
        prev = p.rawGet(cur);
        rc = p.get2DInd(prev);
        pr = rc.r - 1;
        pc = rc.c - 1;
        if (pr === cr) {
          operations.unshift({
            type: "i",
            otherTree: cc + offset,
            pos: cr + 1 + offset
          });
        } else if (pc === cc) {
          operations.unshift({
            type: "d",
            tree: cr + offset
          });
        } else {
          op = this.children[cr + offset].diff(otherTree.children[cc + offset]).operations;
          if (op && op.length) {
            operations.unshift({
              type: "r",
              tree: cr + offset,
              otherTree: cc + offset
            });
          }
        }
        cur = prev;
        cr = pr;
        cc = pc;
      }
      this.diffHash[key] = {
        score: score,
        operations: operations
      };
      return this.diffHash[key];
    };

    WrappedDomTree.prototype.equalTo = function(otherTree) {
      return this.dom.isEqualNode(otherTree.dom);
    };

    WrappedDomTree.prototype.cannotReplaceWith = function(otherTree) {
      return this.isText || otherTree.isText || this.tagName !== otherTree.tagName || this.className !== otherTree.className || this.className === "math" || this.className === "atom-text-editor" || this.tagName === "A" || (this.tagName === "IMG" && !this.dom.isEqualNode(otherTree.dom));
    };

    WrappedDomTree.prototype.getContent = function() {
      if (this.dom.outerHTML) {
        return this.dom.outerHTML;
      } else {
        return this.textData;
      }
    };

    WrappedDomTree.prototype.removeSelf = function() {
      hashTo[this.hash] = null;
      this.children && this.children.forEach(function(c) {
        return c.removeSelf();
      });
    };

    return WrappedDomTree;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL2hvbWUvbWFyY3VzLy5hdG9tL3BhY2thZ2VzL21hcmtkb3duLXByZXZpZXctcGx1cy9saWIvd3JhcHBlZC1kb20tdHJlZS5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBc0JBO0VBQUE7QUFBQSxNQUFBLDRDQUFBO0lBQUE7O0VBRUEsV0FBQSxHQUFjLE9BQUEsQ0FBUSxpQkFBUjs7RUFFZCxPQUFBLEdBQVU7O0VBQ1YsTUFBQSxHQUFVOztFQUVWLE1BQU0sQ0FBQyxPQUFQLEdBQXVCO0lBS1Isd0JBQUMsR0FBRCxFQUFNLEtBQU4sRUFBYSxHQUFiO01BQ1gsSUFBRyxLQUFIO1FBQ0UsSUFBQyxDQUFBLFNBQUQsR0FBa0IsSUFBQSxjQUFBLENBQWUsR0FBZixFQUFvQixLQUFwQixFQUEyQixJQUEzQjtRQUNsQixJQUFDLENBQUEsR0FBRCxHQUFjLEdBQUcsQ0FBQyxTQUFKLENBQWMsSUFBZCxFQUZoQjtPQUFBLE1BQUE7UUFJRSxJQUFDLENBQUEsR0FBRCxHQUFPO1FBQ1AsSUFBQyxDQUFBLEdBQUQsR0FBTyxJQUxUOztNQU9BLElBQUMsQ0FBQSxLQUFELEdBQWdCO01BQ2hCLElBQUMsQ0FBQSxJQUFELEdBQWdCLE9BQUE7TUFDaEIsTUFBTyxDQUFBLElBQUMsQ0FBQSxJQUFELENBQVAsR0FBZ0I7TUFDaEIsSUFBQyxDQUFBLE1BQUQsR0FBZ0IsR0FBRyxDQUFDLFFBQUosS0FBZ0I7TUFDaEMsSUFBQyxDQUFBLE9BQUQsR0FBZ0IsR0FBRyxDQUFDO01BQ3BCLElBQUMsQ0FBQSxTQUFELEdBQWdCLEdBQUcsQ0FBQztNQUNwQixJQUFDLENBQUEsUUFBRCxHQUFnQixHQUFHLENBQUM7TUFDcEIsSUFBQyxDQUFBLFFBQUQsR0FBZ0I7TUFFaEIsSUFBRyxJQUFDLENBQUEsTUFBSjtRQUNFLElBQUMsQ0FBQSxJQUFELEdBQVEsRUFEVjtPQUFBLE1BQUE7UUFHRSxHQUFBLEdBQU0sSUFBQyxDQUFBO1FB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QSxJQUFDLENBQUEsU0FBRCxLQUFjLE1BSmQsSUFLQSxJQUFDLENBQUEsU0FBRCxLQUFjLGtCQUxkLElBTUEsSUFBQyxDQUFBLE9BQUQsS0FBWSxHQU5aLElBT0EsQ0FBQyxJQUFDLENBQUEsT0FBRCxLQUFZLEtBQVosSUFBc0IsQ0FBSSxJQUFDLENBQUEsR0FBRyxDQUFDLFdBQUwsQ0FBaUIsU0FBUyxDQUFDLEdBQTNCLENBQTNCO0lBUmlCOzs2QkFVbkIsVUFBQSxHQUFZLFNBQUE7TUFDVixJQUFHLElBQUMsQ0FBQSxHQUFHLENBQUMsU0FBUjtBQUNFLGVBQU8sSUFBQyxDQUFBLEdBQUcsQ0FBQyxVQURkO09BQUEsTUFBQTtBQUdFLGVBQU8sSUFBQyxDQUFBLFNBSFY7O0lBRFU7OzZCQU1aLFVBQUEsR0FBWSxTQUFBO01BQ1YsTUFBTyxDQUFBLElBQUMsQ0FBQSxJQUFELENBQVAsR0FBZ0I7TUFDaEIsSUFBQyxDQUFBLFFBQUQsSUFBYyxJQUFDLENBQUEsUUFBUSxDQUFDLE9BQVYsQ0FBa0IsU0FBQyxDQUFEO2VBQzlCLENBQUMsQ0FBQyxVQUFGLENBQUE7TUFEOEIsQ0FBbEI7SUFGSjs7Ozs7QUE3UWQiLCJzb3VyY2VzQ29udGVudCI6WyIjIFRoaXMgZmlsZSBpbmNvcnBvcmF0ZXMgY29kZSBmcm9tIFttYXJrbW9uXShodHRwczovL2dpdGh1Yi5jb20veXlqaGFvL21hcmttb24pXG4jIGNvdmVyZWQgYnkgdGhlIGZvbGxvd2luZyB0ZXJtczpcbiNcbiMgQ29weXJpZ2h0IChjKSAyMDE0LCBZYW8gWXVqaWFuLCBodHRwOi8veWp5YW8uY29tXG4jXG4jIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiMgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuIyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4jIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiMgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4jIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4jXG4jIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4jIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuI1xuIyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4jIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuIyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiMgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuIyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuIyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4jIFRIRSBTT0ZUV0FSRS5cblwidXNlIHN0cmljdFwiXG5cblR3b0RpbUFycmF5ID0gcmVxdWlyZSAnLi90d28tZGltLWFycmF5J1xuXG5jdXJIYXNoID0gMFxuaGFzaFRvICA9IHt9XG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgV3JhcHBlZERvbVRyZWVcbiAgIyBAcGFyYW0gZG9tIEEgRE9NIGVsZW1lbnQgb2JqZWN0XG4gICMgICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgIyBAcGFyYW0gY2xvbmUgQm9vbGVhbiBmbGFnIGluZGljYXRpbmcgaWYgdGhpcyBpcyB0aGUgRE9NIHRyZWUgdG8gbW9kaWZ5XG4gICMgQHBhcmFtIHJlcCBXcmFwcGVkRG9tVHJlZSBvZiBhIERPTSBlbGVtZW50IG5vZGUgaW4gZG9tXG4gIGNvbnN0cnVjdG9yOiAoZG9tLCBjbG9uZSwgcmVwKSAtPlxuICAgIGlmIGNsb25lXG4gICAgICBAc2hvd25UcmVlICA9IG5ldyBXcmFwcGVkRG9tVHJlZSBkb20sIGZhbHNlLCB0aGlzXG4gICAgICBAZG9tICAgICAgICA9IGRvbS5jbG9uZU5vZGUgdHJ1ZVxuICAgIGVsc2VcbiAgICAgIEBkb20gPSBkb21cbiAgICAgIEByZXAgPSByZXBcblxuICAgIEBjbG9uZSAgICAgICAgPSBjbG9uZVxuICAgIEBoYXNoICAgICAgICAgPSBjdXJIYXNoKytcbiAgICBoYXNoVG9bQGhhc2hdID0gdGhpc1xuICAgIEBpc1RleHQgICAgICAgPSBkb20ubm9kZVR5cGUgaXMgM1xuICAgIEB0YWdOYW1lICAgICAgPSBkb20udGFnTmFtZVxuICAgIEBjbGFzc05hbWUgICAgPSBkb20uY2xhc3NOYW1lXG4gICAgQHRleHREYXRhICAgICA9IGRvbS5kYXRhXG4gICAgQGRpZmZIYXNoICAgICA9IHt9XG5cbiAgICBpZiBAaXNUZXh0XG4gICAgICBAc2l6ZSA9IDFcbiAgICBlbHNlXG4gICAgICByZXAgPSBAcmVwXG4gICAgICBAY2hpbGRyZW4gPSBbXS5tYXAuY2FsbCBAZG9tLmNoaWxkTm9kZXMsIChkb20sIGluZCkgLT5cbiAgICAgICAgbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgZmFsc2UsIGlmIHJlcCB0aGVuIHJlcC5jaGlsZHJlbltpbmRdIGVsc2UgbnVsbClcbiAgICAgIEBzaXplID0gaWYgQGNoaWxkcmVuLmxlbmd0aCB0aGVuIEBjaGlsZHJlbi5yZWR1Y2UgKCAocHJldiwgY3VyKSAtPlxuICAgICAgICBwcmV2ICsgY3VyLnNpemUgKSwgMCBlbHNlIDBcbiAgICAgIHVubGVzcyBAc2l6ZVxuICAgICAgICBAc2l6ZSA9IDFcblxuICAjIEBwYXJhbSBvdGhlclRyZWUgV3JhcHBlZERvbVRyZWUgb2YgYSBET00gZWxlbWVudCB0byBkaWZmIGFnYWluc3RcbiAgZGlmZlRvOiAob3RoZXJUcmVlKSAtPlxuICAgIGlmIEBjbG9uZVxuICAgICAgcmV0dXJuIEBzaG93blRyZWUuZGlmZlRvIG90aGVyVHJlZVxuXG4gICAgZGlmZiAgICAgICAgPSBAcmVwLmRpZmYgb3RoZXJUcmVlXG4gICAgc2NvcmUgICAgICAgPSBkaWZmLnNjb3JlXG4gICAgb3BlcmF0aW9ucyAgPSBkaWZmLm9wZXJhdGlvbnNcbiAgICBpbmRleFNoaWZ0ICA9IDBcbiAgICBpbnNlcnRlZCAgICA9IFtdXG5cbiAgICAjIEZvcmNlIHZhcmlhYmxlcyB0byBsZWFrIHRvIGRpZmZUbyBzY29wZVxuICAgIFtsYXN0LCBwb3NzaWJsZVJlcGxhY2UsIHIsIGxhc3RPcCwgbGFzdEVsbURlbGV0ZWQsIGxhc3RFbG1JbnNlcnRlZF0gPSBbXVxuXG4gICAgaWYgb3BlcmF0aW9uc1xuICAgICAgaWYgb3BlcmF0aW9ucyBpbnN0YW5jZW9mIEFycmF5XG4gICAgICAgIGZvciBvcCBpbiBvcGVyYXRpb25zXG4gICAgICAgICAgZG8gKG9wKSA9PlxuICAgICAgICAgICAgaWYgb3AudHlwZSBpcyBcImRcIlxuICAgICAgICAgICAgICBwb3NzaWJsZUxhc3REZWxldGVkID0gQGNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XS5kb21cbiAgICAgICAgICAgICAgciA9IEByZW1vdmUgb3AudHJlZSArIGluZGV4U2hpZnRcbiAgICAgICAgICAgICAgQHJlcC5yZW1vdmUgb3AudHJlZSArIGluZGV4U2hpZnRcbiAgICAgICAgICAgICAgaWYgbm90IGxhc3Qgb3IgbGFzdC5uZXh0U2libGluZyBpcyByIG9yIGxhc3QgaXMgclxuICAgICAgICAgICAgICAgIGxhc3QgPSByXG4gICAgICAgICAgICAgICAgIyBVbmRlZmluZWQgZXJyb3JzIGNhbiBiZSB0aHJvdyBzbyB3ZSBhZGQgYSBjb25kaXRpb24gb24gbGFzdE9wXG4gICAgICAgICAgICAgICAgIyBiZWluZyBkZWZpbmVkXG4gICAgICAgICAgICAgICAgaWYgbGFzdCBhbmQgbGFzdE9wIGFuZCBvcC50cmVlIGlzIGxhc3RPcC5wb3NcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1EZWxldGVkID0gcG9zc2libGVMYXN0RGVsZXRlZFxuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1EZWxldGVkICA9IG51bGxcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IG51bGxcbiAgICAgICAgICAgICAgICBsYXN0T3AgPSBvcFxuICAgICAgICAgICAgICBpbmRleFNoaWZ0LS1cbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICBlbHNlIGlmIG9wLnR5cGUgaXMgXCJpXCJcbiAgICAgICAgICAgICAgQHJlcC5pbnNlcnQgb3AucG9zICsgaW5kZXhTaGlmdCwgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV1cbiAgICAgICAgICAgICAgciA9IEBpbnNlcnQgb3AucG9zICsgaW5kZXhTaGlmdCwgb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV0sIEByZXAuY2hpbGRyZW5bb3AucG9zICsgaW5kZXhTaGlmdF1cbiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChyKVxuICAgICAgICAgICAgICBpZiBub3QgbGFzdCBvciBsYXN0Lm5leHRTaWJsaW5nIGlzIHJcbiAgICAgICAgICAgICAgICBsYXN0ID0gclxuICAgICAgICAgICAgICAgIGxhc3RPcCA9IG9wXG4gICAgICAgICAgICAgICAgbGFzdEVsbUluc2VydGVkID0gclxuICAgICAgICAgICAgICBpbmRleFNoaWZ0KytcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgIHJlID0gQGNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XS5kaWZmVG8gb3RoZXJUcmVlLmNoaWxkcmVuW29wLm90aGVyVHJlZV1cbiAgICAgICAgICAgICAgaWYgbm90IGxhc3Qgb3IgKGxhc3QubmV4dFNpYmxpbmcgaXMgQGNoaWxkcmVuW29wLnRyZWUgKyBpbmRleFNoaWZ0XS5kb20gYW5kIHJlLmxhc3QpXG4gICAgICAgICAgICAgICAgbGFzdCA9IHJlLmxhc3RcbiAgICAgICAgICAgICAgICBpZiByZS5wb3NzaWJsZVJlcGxhY2VcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1JbnNlcnRlZCA9IHJlLnBvc3NpYmxlUmVwbGFjZS5jdXJcbiAgICAgICAgICAgICAgICAgIGxhc3RFbG1EZWxldGVkICA9IHJlLnBvc3NpYmxlUmVwbGFjZS5wcmV2XG4gICAgICAgICAgICAgICAgbGFzdE9wID0gb3BcbiAgICAgICAgICAgICAgaW5zZXJ0ZWQgPSBpbnNlcnRlZC5jb25jYXQgcmUuaW5zZXJ0ZWRcbiAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICBlbHNlXG4gICAgICAgIGNvbnNvbGUubG9nIG9wZXJhdGlvbnNcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yIFwiaW52YWxpZCBvcGVyYXRpb25zXCJcblxuICAgIGlmIGxhc3RPcCBhbmQgbGFzdE9wLnR5cGUgaXNudCAnaScgYW5kIGxhc3RFbG1JbnNlcnRlZCBhbmQgbGFzdEVsbURlbGV0ZWRcbiAgICAgIHBvc3NpYmxlUmVwbGFjZSA9XG4gICAgICAgIGN1cjogbGFzdEVsbUluc2VydGVkXG4gICAgICAgIHByZXY6IGxhc3RFbG1EZWxldGVkXG5cbiAgICBsYXN0OiBsYXN0XG4gICAgaW5zZXJ0ZWQ6IGluc2VydGVkXG4gICAgcG9zc2libGVSZXBsYWNlOiBwb3NzaWJsZVJlcGxhY2VcblxuICBpbnNlcnQ6IChpLCB0cmVlLCByZXApIC0+XG4gICAgZG9tID0gdHJlZS5kb20uY2xvbmVOb2RlIHRydWVcbiAgICBpZiBpIGlzIEBkb20uY2hpbGROb2Rlcy5sZW5ndGhcbiAgICAgIEBkb20uYXBwZW5kQ2hpbGQgZG9tXG4gICAgZWxzZVxuICAgICAgQGRvbS5pbnNlcnRCZWZvcmUgZG9tLCBAZG9tLmNoaWxkTm9kZXNbaV1cblxuICAgIGN0cmVlID0gbmV3IFdyYXBwZWREb21UcmVlIGRvbSwgZmFsc2UsIHJlcFxuICAgIEBjaGlsZHJlbi5zcGxpY2UgaSwgMCwgY3RyZWVcbiAgICBAZG9tLmNoaWxkTm9kZXNbaV1cblxuICByZW1vdmU6IChpKSAtPlxuICAgIEBkb20ucmVtb3ZlQ2hpbGQgQGRvbS5jaGlsZE5vZGVzW2ldXG4gICAgQGNoaWxkcmVuW2ldLnJlbW92ZVNlbGYoKVxuICAgIEBjaGlsZHJlbi5zcGxpY2UgaSwgMVxuICAgIEBkb20uY2hpbGROb2Rlc1tpLTFdXG5cbiAgZGlmZjogKG90aGVyVHJlZSwgdG1heCkgLT5cbiAgICBpZiBAZXF1YWxUbyBvdGhlclRyZWVcbiAgICAgIHJldHVybiBzY29yZTogMCwgb3BlcmF0aW9uczogbnVsbFxuXG4gICAgaWYgQGNhbm5vdFJlcGxhY2VXaXRoIG90aGVyVHJlZVxuICAgICAgcmV0dXJuIHNjb3JlOiAxLzAsIG9wZXJhdGlvbnM6IG51bGxcblxuICAgIGtleSA9IG90aGVyVHJlZS5oYXNoXG4gICAgaWYga2V5IGluIEBkaWZmSGFzaFxuICAgICAgcmV0dXJuIEBkaWZmSGFzaFtrZXldXG5cbiAgICBpZiB0bWF4IGlzIHVuZGVmaW5lZFxuICAgICAgdG1heCA9IDEwMDAwMFxuICAgIGlmIHRtYXggPD0gMFxuICAgICAgcmV0dXJuIDBcblxuICAgIG9mZnNldCA9IDBcbiAgICBmb3J3YXJkU2VhcmNoID0gKG9mZnNldCkgPT5cbiAgICAgIG9mZnNldCA8IEBjaGlsZHJlbi5sZW5ndGggYW5kXG4gICAgICBvZmZzZXQgPCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIGFuZFxuICAgICAgQGNoaWxkcmVuW29mZnNldF0uZXF1YWxUbyBvdGhlclRyZWUuY2hpbGRyZW5bb2Zmc2V0XVxuICAgIHdoaWxlIGZvcndhcmRTZWFyY2gob2Zmc2V0KVxuICAgICAgb2Zmc2V0KytcblxuICAgIGRwID0gbmV3IFR3b0RpbUFycmF5IEBjaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldFxuICAgIHAgID0gbmV3IFR3b0RpbUFycmF5IEBjaGlsZHJlbi5sZW5ndGggKyAxIC0gb2Zmc2V0LCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoICsgMSAtIG9mZnNldFxuICAgIGRwLnNldCAwLCAwLCAwXG5cbiAgICBzdW0gPSAwXG4gICAgIyBCZWNhdXNlIGNvZmZlc2NyaXB0cyBhbGxvd3MgYmlkZXJjdGlvbmFsIGxvb3BzIHdlIG5lZWQgdGhpcyBjb25kaXRpb25cbiAgICAjIGdhdXJkIHRvIHByZXZlbnQgYSBkZWNyZWFzaW5nIGFycmF5IGxpc3RcbiAgICBpZiBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0ID4gMVxuICAgICAgZm9yIGkgaW4gWzEuLihvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0IC0gMSldXG4gICAgICAgIGRwLnNldCAwLCBpLCBzdW1cbiAgICAgICAgcC5zZXQgMCwgaSwgaS0xXG4gICAgICAgIHN1bSArPSBvdGhlclRyZWUuY2hpbGRyZW5baSArIG9mZnNldF0uc2l6ZVxuICAgIGlmIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQgPiAwXG4gICAgICBkcC5zZXQgMCwgb3RoZXJUcmVlLmNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCwgc3VtXG4gICAgICBwLnNldCAwLCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCBvdGhlclRyZWUuY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldFxuXG4gICAgc3VtID0gMFxuICAgICMgQmVjYXVzZSBjb2ZmZXNjcmlwdHMgYWxsb3dzIGJpZGVyY3Rpb25hbCBsb29wcyB3ZSBuZWVkIHRoaXMgY29uZGl0aW9uXG4gICAgIyBnYXVyZCB0byBwcmV2ZW50IGEgZGVjcmVhc2luZyBhcnJheSBsaXN0XG4gICAgaWYgQGNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCA+IDFcbiAgICAgIGZvciBpIGluIFsxLi4oQGNoaWxkcmVuLmxlbmd0aCAtIG9mZnNldCAtIDEpXVxuICAgICAgICBkcC5zZXQgaSwgMCwgc3VtXG4gICAgICAgIHAuc2V0IGksIDAsIChpLTEpKnAuY29sXG4gICAgICAgIHN1bSArPSBAY2hpbGRyZW5baSArIG9mZnNldF0uc2l6ZVxuICAgIGlmIEBjaGlsZHJlbi5sZW5ndGggLSBvZmZzZXRcbiAgICAgIGRwLnNldCBAY2hpbGRyZW4ubGVuZ3RoIC0gb2Zmc2V0LCAwLCBzdW1cbiAgICAgIHAuc2V0IEBjaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIDAsIChAY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldCkqcC5jb2xcblxuICAgIGdldFNjb3JlID0gKGksIGosIG1heCkgPT5cbiAgICAgIGlmIGRwLmdldChpLCBqKSBpc250IHVuZGVmaW5lZFxuICAgICAgICByZXR1cm4gZHAuZ2V0KGksIGopXG4gICAgICBpZiBtYXggaXMgdW5kZWZpbmVkXG4gICAgICAgIG1heCA9IDEvMFxuICAgICAgaWYgbWF4IDw9IDBcbiAgICAgICAgcmV0dXJuIDEvMFxuXG4gICAgICB2YWwgICAgID0gbWF4XG4gICAgICBib3VuZCAgID0gbWF4XG4gICAgICBzdWJkaWZmID0gQGNoaWxkcmVuW2kgLSAxICsgb2Zmc2V0XS5kaWZmKCBvdGhlclRyZWUuY2hpbGRyZW5baiAtIDEgKyBvZmZzZXRdLCBib3VuZCkuc2NvcmVcbiAgICAgIGZvcmNlICAgPSBmYWxzZVxuICAgICAgaWYgc3ViZGlmZiA8IGJvdW5kIGFuZCBzdWJkaWZmICsgMSA8IEBjaGlsZHJlbltpIC0gMSArIG9mZnNldF0uc2l6ZSArIG90aGVyVHJlZS5jaGlsZHJlbltqIC0gMSArIG9mZnNldF0uc2l6ZVxuICAgICAgICBmb3JjZSA9IHRydWVcbiAgICAgIHZhbCA9IGdldFNjb3JlKGktMSwgai0xLCBib3VuZCAtIHN1YmRpZmYpICsgc3ViZGlmZlxuICAgICAgcHJldiA9IHAuZ2V0SW5kIGktMSwgai0xXG5cbiAgICAgIHVubGVzcyBmb3JjZVxuICAgICAgICBvdGhlciA9IGdldFNjb3JlKGktMSwgaiwgTWF0aC5taW4odmFsLCBtYXgpIC0gQGNoaWxkcmVuW2ktMStvZmZzZXRdLnNpemUpICsgQGNoaWxkcmVuW2ktMStvZmZzZXRdLnNpemVcbiAgICAgICAgaWYgb3RoZXIgPCB2YWxcbiAgICAgICAgICBwcmV2ICA9IHAuZ2V0SW5kIGktMSwgalxuICAgICAgICAgIHZhbCAgID0gb3RoZXJcblxuICAgICAgICBvdGhlciA9IGdldFNjb3JlKGksIGotMSwgTWF0aC5taW4odmFsLCBtYXgpIC0gb3RoZXJUcmVlLmNoaWxkcmVuW2otMStvZmZzZXRdLnNpemUpICsgb3RoZXJUcmVlLmNoaWxkcmVuW2otMStvZmZzZXRdLnNpemVcbiAgICAgICAgaWYgb3RoZXIgPCB2YWxcbiAgICAgICAgICBwcmV2ICA9IHAuZ2V0SW5kIGksIGotMVxuICAgICAgICAgIHZhbCAgID0gb3RoZXJcblxuICAgICAgaWYgdmFsID49IG1heFxuICAgICAgICB2YWwgPSAxLzBcblxuICAgICAgZHAuc2V0IGksIGosIHZhbFxuICAgICAgcC5zZXQgaSwgaiwgcHJldlxuICAgICAgdmFsXG5cbiAgICBzY29yZSA9IGdldFNjb3JlIEBjaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIHRtYXhcbiAgICBvcGVyYXRpb25zID0gW11cblxuICAgIGN1ciA9IHAuZ2V0SW5kIEBjaGlsZHJlbi5sZW5ndGggLSBvZmZzZXQsIG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSBvZmZzZXRcbiAgICBjciAgPSBAY2hpbGRyZW4ubGVuZ3RoIC0gMSAtIG9mZnNldFxuICAgIGNjICA9IG90aGVyVHJlZS5jaGlsZHJlbi5sZW5ndGggLSAxIC0gb2Zmc2V0XG5cbiAgICB3aGlsZSBwLnJhd0dldChjdXIpIGlzbnQgdW5kZWZpbmVkXG4gICAgICBwcmV2ICA9IHAucmF3R2V0IGN1clxuICAgICAgcmMgICAgPSBwLmdldDJESW5kIHByZXZcbiAgICAgIHByICAgID0gcmMuciAtIDFcbiAgICAgIHBjICAgID0gcmMuYyAtIDFcblxuICAgICAgaWYgcHIgaXMgY3JcbiAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0XG4gICAgICAgICAgdHlwZTogXCJpXCJcbiAgICAgICAgICBvdGhlclRyZWU6IGNjICsgb2Zmc2V0XG4gICAgICAgICAgcG9zOiBjciArIDEgKyBvZmZzZXRcbiAgICAgIGVsc2UgaWYgcGMgaXMgY2NcbiAgICAgICAgb3BlcmF0aW9ucy51bnNoaWZ0XG4gICAgICAgICAgdHlwZTogXCJkXCJcbiAgICAgICAgICB0cmVlOiBjciArIG9mZnNldFxuICAgICAgZWxzZVxuICAgICAgICBvcCA9IEBjaGlsZHJlbltjciArIG9mZnNldF0uZGlmZihvdGhlclRyZWUuY2hpbGRyZW5bY2MgKyBvZmZzZXRdKS5vcGVyYXRpb25zXG4gICAgICAgIGlmIG9wIGFuZCBvcC5sZW5ndGhcbiAgICAgICAgICBvcGVyYXRpb25zLnVuc2hpZnRcbiAgICAgICAgICAgIHR5cGU6IFwiclwiXG4gICAgICAgICAgICB0cmVlOiBjciArIG9mZnNldFxuICAgICAgICAgICAgb3RoZXJUcmVlOiBjYyArIG9mZnNldFxuICAgICAgY3VyID0gcHJldlxuICAgICAgY3IgID0gcHJcbiAgICAgIGNjICA9IHBjXG5cbiAgICBAZGlmZkhhc2hba2V5XSA9XG4gICAgICBzY29yZTogc2NvcmVcbiAgICAgIG9wZXJhdGlvbnM6IG9wZXJhdGlvbnNcblxuICAgIEBkaWZmSGFzaFtrZXldXG5cbiAgZXF1YWxUbzogKG90aGVyVHJlZSkgLT5cbiAgICBAZG9tLmlzRXF1YWxOb2RlIG90aGVyVHJlZS5kb21cblxuICBjYW5ub3RSZXBsYWNlV2l0aDogKG90aGVyVHJlZSkgLT5cbiAgICBAaXNUZXh0IG9yXG4gICAgb3RoZXJUcmVlLmlzVGV4dCBvclxuICAgIEB0YWdOYW1lIGlzbnQgb3RoZXJUcmVlLnRhZ05hbWUgb3JcbiAgICBAY2xhc3NOYW1lIGlzbnQgb3RoZXJUcmVlLmNsYXNzTmFtZSBvclxuICAgIEBjbGFzc05hbWUgaXMgXCJtYXRoXCIgb3JcbiAgICBAY2xhc3NOYW1lIGlzIFwiYXRvbS10ZXh0LWVkaXRvclwiIG9yXG4gICAgQHRhZ05hbWUgaXMgXCJBXCIgb3JcbiAgICAoQHRhZ05hbWUgaXMgXCJJTUdcIiBhbmQgbm90IEBkb20uaXNFcXVhbE5vZGUob3RoZXJUcmVlLmRvbSkpXG5cbiAgZ2V0Q29udGVudDogLT5cbiAgICBpZiBAZG9tLm91dGVySFRNTFxuICAgICAgcmV0dXJuIEBkb20ub3V0ZXJIVE1MXG4gICAgZWxzZVxuICAgICAgcmV0dXJuIEB0ZXh0RGF0YVxuXG4gIHJlbW92ZVNlbGY6IC0+XG4gICAgaGFzaFRvW0BoYXNoXSA9IG51bGxcbiAgICBAY2hpbGRyZW4gYW5kIEBjaGlsZHJlbi5mb3JFYWNoIChjKSAtPlxuICAgICAgYy5yZW1vdmVTZWxmKClcbiAgICByZXR1cm5cbiJdfQ==
